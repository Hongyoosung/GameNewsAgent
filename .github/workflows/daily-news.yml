# .github/workflows/daily-news.yml (전체 코드 중 steps 부분 수정)

name: Daily News Automation
on:
  schedule:
    - cron: '0 0 * * *'  # UTC 00:00 -> KST 09:00
  workflow_dispatch:  # 수동 실행 버튼 활성화

jobs:
  run-daily-news:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Repo
        uses: actions/checkout@v4
        with:
          path: sourcerepo
      
      - name: Checkout Target Repo (Blog)
        uses: actions/checkout@v4
        with:
          repository: Hongyoosung/Hongyoosung.github.io
          token: ${{ secrets.GH_PAT }}
          path: targetrepo
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Install OpenClaw
        run: npm install -g openclaw@latest
      
      - name: Create .env
        working-directory: ./sourcerepo
        run: |
          cat > .env << EOF
          GITHUB_TOKEN=${{ secrets.GH_PAT }}
          TARGET_REPO_PATH=${{ github.workspace }}/targetrepo
          REPO_PATH=./repo
          OPENCLAW_CONFIG=./config
          OPENCLAW_DAILY_JOB_ID=daily-news
          CONTAINER_TIMEZONE=Asia/Seoul
          OPENAI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          OPENAI_BASE_URL=https://generativelanguage.googleapis.com/v1beta/openai/
          OPENCLAW_MODEL=openai/gemini-2.5-flash
          EOF
      
      - name: Create OpenClaw Config & Dummy Auth
        run: |
          # 1. OpenClaw의 기본 설정 디렉토리 생성
          mkdir -p ~/.openclaw
          
          # 2. 커스텀 모델(Gemini) 설정 파일 생성 (올바른 경로에 배치)
          cat > ~/.openclaw/openclaw.json << EOF
          {
            "models": {
              "mode": "merge",
              "providers": {
                "google-gemini": {
                  "baseUrl": "https://generativelanguage.googleapis.com/v1beta/openai/",
                  "api": "openai-completions",
                  "apiKey": "${{ secrets.GEMINI_API_KEY }}",
                  "models": [
                    {
                      "id": "gemini-2.5-flash",
                      "name": "Gemini 2.5 Flash"
                    }
                  ]
                }
              }
            },
            "agents": {
              "defaults": {
                "model": {
                  "primary": "google-gemini/gemini-2.5-flash"
                }
              }
            }
          }
          EOF
          
          # 3. 만약을 대비한 Anthropic 더미(Dummy) 키 생성 (초기화 에러 완벽 우회)
          mkdir -p ~/.openclaw/agents/main/agent
          cat > ~/.openclaw/agents/main/agent/auth-profiles.json << EOF
          {
            "anthropic": {
              "apiKey": "dummy-key-to-bypass-check"
            }
          }
          EOF

      - name: Configure Git for Target Repo
        working-directory: ./targetrepo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Run Daily Script
        working-directory: ./sourcerepo
        run: bash scripts/run-daily.sh