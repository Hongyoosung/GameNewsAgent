# .github/workflows/daily-news.yml (전체 코드 중 steps 부분 수정)

name: Daily News Automation
on:
  schedule:
    - cron: '0 0 * * *'  # UTC 00:00 -> KST 09:00
  workflow_dispatch:  # 수동 실행 버튼 활성화

jobs:
  run-daily-news:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Repo
        uses: actions/checkout@v4
        with:
          path: sourcerepo
      
      - name: Checkout Target Repo (Blog)
        uses: actions/checkout@v4
        with:
          repository: Hongyoosung/Hongyoosung.github.io
          token: ${{ secrets.GH_PAT }}
          path: targetrepo
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Install OpenClaw
        run: npm install -g openclaw@latest
      
      - name: Setup Environment & OpenClaw Auth
        working-directory: ./sourcerepo
        run: |
          # 1. .env 파일 생성 (Target Repo 경로만 설정)
          cat > .env << EOF
          GITHUB_TOKEN=${{ secrets.GH_PAT }}
          TARGET_REPO_PATH=${{ github.workspace }}/targetrepo
          GOOGLE_API_KEY=${{ secrets.GEMINI_API_KEY }}
          EOF
          
          # 2. OpenClaw 글로벌 설정 및 인증 프로필 설정
          # openclaw scan은 OpenRouter 키를 요구하므로 생략합니다.
          # --no-color를 사용하여 CI 로그에서 토큰이 문자로 노출되는 애니메이션 효과를 방지합니다.
          echo "${{ secrets.GEMINI_API_KEY }}" | openclaw --no-color models auth paste-token --provider google
          
          # 3. 'main' 에이전트 설정
          # 'main' 에이전트는 예약된 이름이므로 기존 에이전트에 모델을 강제로 설정합니다.
          openclaw --no-color models --agent main set google/gemini-3.0-flash
          
          # 4. 설정 확인 (디버깅용)
          openclaw --no-color models status
          openclaw --no-color models status --agent main




      - name: Configure Git for Target Repo
        working-directory: ./targetrepo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Run Daily Script
        working-directory: ./sourcerepo
        run: bash scripts/run-daily.sh